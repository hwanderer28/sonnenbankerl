<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonnenbankerl - Bench Testing Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Sora, sans-serif; }
        #map { width: 100vw; height: 100vh; }
        .sunny-marker { background-color: #E7B03F; border-radius: 50%; }
        .shady-marker { background-color: #174656; border-radius: 50%; }
        .info-popup { font-size: 14px; }
        #info-bar { position: fixed; top: 22px; left: 50%; transform: translateX(-50%); background-color: rgba(23, 70, 86, 0.92); color: #f7f7f7; padding: 14px 22px; border-radius: 14px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18); text-align: center; z-index: 1000; min-width: 200px; }
        #time { color: #E7B03F; font-weight: 800; font-size: 22px; letter-spacing: 0.4px; }
        #date { color: #E7B03F; font-weight: 700; font-size: 16px; margin-top: 2px; }
        #bench-stats { margin-top: 8px; font-size: 14px; opacity: 0.95; font-weight: 600; }
        .leaflet-control-locate { margin-top: 4px; }
        .leaflet-control-locate button { width: 34px; height: 34px; background: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .leaflet-control-locate button:focus { outline: none; }
        .leaflet-control-locate button:hover { background: #f2f2f2; }
        .leaflet-control-locate .locate-icon { width: 14px; height: 14px; border: 2px solid #174656; border-radius: 50%; box-sizing: border-box; }
        .leaflet-control-locate button.locating .locate-icon { border-color: #E7B03F; box-shadow: 0 0 0 2px rgba(231, 176, 63, 0.35); }
    </style>
</head>
<body>
    <div id="info-bar">
        <div id="time"></div>
        <div id="date"></div>
        <div id="bench-stats">Loading bench stats...</div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const timeEl = document.getElementById('time');
        const dateEl = document.getElementById('date');
        const statsEl = document.getElementById('bench-stats');

        function updateDateTime() {
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString(undefined, {
                hour: '2-digit',
                minute: '2-digit'
            });
            dateEl.textContent = now.toLocaleDateString(undefined, {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Initialize map centered at Graz with zoom 14
        const map = L.map('map').setView([47.07732, 15.45262], 16);

        // Add MapTiler toner-v2 tiles
        L.tileLayer('https://api.maptiler.com/maps/toner-v2/{z}/{x}/{y}.png?key=C9fT2TaSHBuQXOAelDdr', {
            attribution: '© <a href="https://www.maptiler.com/">MapTiler</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 22
        }).addTo(map);

        let userMarker = null;
        let accuracyCircle = null;

        function locateUser(buttonEl) {
            if (!navigator.geolocation) {
                alert('Geolocation not supported by this browser.');
                return;
            }

            buttonEl.classList.add('locating');

            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude, accuracy } = position.coords;
                    const userLatLng = [latitude, longitude];

                    if (userMarker) {
                        userMarker.setLatLng(userLatLng);
                    } else {
                        userMarker = L.marker(userLatLng, {
                            icon: L.divIcon({
                                className: 'user-marker',
                                html: '<div style="width:14px;height:14px;background:#E7B03F;border:2px solid #174656;border-radius:50%;"></div>',
                                iconSize: [18, 18],
                                iconAnchor: [9, 9]
                            })
                        }).addTo(map);
                    }

                    if (accuracyCircle) {
                        accuracyCircle.setLatLng(userLatLng).setRadius(accuracy);
                    } else {
                        accuracyCircle = L.circle(userLatLng, {
                            radius: accuracy,
                            color: '#174656',
                            fillColor: '#E7B03F',
                            fillOpacity: 0.15,
                            weight: 1
                        }).addTo(map);
                    }

                    map.fitBounds(accuracyCircle.getBounds(), { maxZoom: 22 });
                    buttonEl.classList.remove('locating');
                },
                error => {
                    buttonEl.classList.remove('locating');
                    if (error.code === error.PERMISSION_DENIED) {
                        alert('Location permission denied.');
                    } else {
                        alert('Unable to get your location.');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                }
            );
        }

        const LocateControl = L.Control.extend({
            onAdd: function() {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-locate');
                const button = L.DomUtil.create('button', '', container);
                const icon = L.DomUtil.create('span', 'locate-icon', button);
                button.title = 'Locate me';
                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    L.DomEvent.preventDefault(e);
                    locateUser(button);
                });
                return container;
            }
        });

        map.addControl(new LocateControl({ position: 'topleft' }));

        // Function to create custom marker icons
        function createMarkerIcon(status) {
            return L.divIcon({
                className: status === 'sunny' ? 'sunny-marker' : 'shady-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
        }

        // Function to create popup content
        function createPopupContent(bench) {
            let details = '';

            if (bench.sun_until && bench.remaining_minutes !== null) {
                const date = new Date(bench.sun_until);
                const timeText = bench.current_status === 'sunny'
                    ? `Sunny for ${bench.remaining_minutes} more minutes`
                    : `Next sun in ${bench.remaining_minutes} minutes (${date.toLocaleTimeString()})`;
                details += `<div style="font-size:16px; font-weight:800;">${timeText}</div>`;
            } else {
                details += `<div style="font-size:16px; font-weight:800;">No sun change within 7 days</div>`;
            }

            details += `<div style="font-size:12px; margin-top:4px;"><i>Tap for more details</i></div>`;
            return details;
        }

        // Function to create detailed popup content from full bench data
        function createDetailedPopupContent(bench) {
            let details = '';

            if (bench.sun_until && bench.remaining_minutes !== null) {
                const date = new Date(bench.sun_until);
                const timeText = bench.current_status === 'sunny'
                    ? `Sunny for ${bench.remaining_minutes} more minutes`
                    : `Next sun in ${bench.remaining_minutes} minutes (${date.toLocaleTimeString()})`;
                details += `<div style="font-size:16px; font-weight:800;">${timeText}</div>`;
            } else {
                details += `<div style="font-size:16px; font-weight:800;">No sun change within 7 days</div>`;
            }

            if (bench.status_note) {
                details += `<div style="margin-top:6px;">Note: ${bench.status_note}</div>`;
            }

            return details;
        }

        // Fetch benches from API
        async function loadBenches() {
            try {
                const response = await fetch('https://sonnenbankerl-api.ideanexus.cloud/api/benches?lat=47.07732&lon=15.45262&radius=5000');
                const data = await response.json();

                if (data.benches && data.benches.length > 0) {
                    let sunnyCount = 0;
                    let shadyCount = 0;
                    const benchCoords = [];

                    data.benches.forEach(bench => {
                        if (bench.current_status === 'sunny') {
                            sunnyCount += 1;
                        } else if (bench.current_status === 'shady') {
                            shadyCount += 1;
                        }

                        benchCoords.push([bench.location.lat, bench.location.lon]);

                        const marker = L.marker([bench.location.lat, bench.location.lon], {
                            icon: createMarkerIcon(bench.current_status)
                        }).addTo(map);

                        marker.bindPopup(createPopupContent(bench));

                        // Fetch detailed info on click
                        marker.on('click', async function() {
                            try {
                                const detailResponse = await fetch(`https://sonnenbankerl-api.ideanexus.cloud/api/benches/${bench.id}`);
                                const detailData = await detailResponse.json();

                                // Update popup with detailed info
                                const detailedContent = createDetailedPopupContent(detailData);
                                marker.setPopupContent(detailedContent);
                                marker.openPopup();
                            } catch (error) {
                                console.error('Error fetching bench details:', error);
                            }
                        });
                    });

                    if (benchCoords.length) {
                        map.fitBounds(benchCoords, { padding: [20, 20], maxZoom: 20 });
                    }

                    statsEl.textContent = `${sunnyCount} sunny benches · ${shadyCount} shaded benches`;
                    console.log(`Loaded ${data.benches.length} benches`);
                } else {
                    statsEl.textContent = 'No benches found nearby';
                    console.log('No benches found in the area');
                    alert('No benches found. Make sure the backend is running and data is loaded.');
                }
            } catch (error) {
                statsEl.textContent = 'Could not load bench data';
                console.error('Error loading benches:', error);
                alert('Error loading benches. Check console and ensure backend is reachable at https://sonnenbankerl-api.ideanexus.cloud');
            }
        }

        // Load benches when page loads
        loadBenches();
    </script>
</body>
</html>
